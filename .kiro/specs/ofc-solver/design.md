# OFC Solver 技術設計文檔

## 系統架構概述

### 分層架構
```
┌─────────────────────────────────────────┐
│          API Layer (FastAPI)            │
├─────────────────────────────────────────┤
│      Application Layer (Solver)         │
├─────────────────────────────────────────┤
│        Domain Layer (OFC Core)          │
├─────────────────────────────────────────┤
│    Infrastructure Layer (Storage)       │
└─────────────────────────────────────────┘
```

## 領域模型設計 (DDD)

### 核心實體 (Entities)
1. **GameState**
   - 聚合根
   - 管理整個遊戲狀態
   - 包含牌庫、街道、玩家安排

2. **PlayerArrangement**
   - 玩家的牌擺放
   - 包含三個牌墩
   - 驗證規則合法性

### 值對象 (Value Objects)
1. **Card**
   - 不可變的牌表示
   - 使用整數編碼優化

2. **Hand**
   - 3張或5張牌的組合
   - 包含牌型評估

3. **HandType**
   - 牌型分類和強度
   - 用於比較和計分

4. **Score**
   - 計分結果
   - 包含基本分和獎勵分

### 領域服務 (Domain Services)
1. **ScoringSystem**
   - 計算得分
   - 處理犯規和獎勵

2. **HandEvaluator**
   - 評估手牌強度
   - 識別牌型

## 算法設計

### MCTS 架構
```python
class MCTSNode:
    - state: GameState
    - parent: Optional[MCTSNode]
    - children: Dict[Action, MCTSNode]
    - visits: int
    - total_reward: float
    
class MCTSEngine:
    - search(initial_state) -> Action
    - select() -> MCTSNode
    - expand() -> MCTSNode
    - simulate() -> float
    - backpropagate(reward)
```

### 優化策略
1. **位運算表示**
   - Card: 6 bits (0-51)
   - CardSet: 64-bit integer

2. **並行化**
   - Root parallelization
   - Leaf parallelization
   - Virtual loss

3. **剪枝**
   - Alpha-beta pruning
   - Domain knowledge pruning

## 數據流設計

### 求解流程
```
用戶請求 → API 接收 → 創建求解任務 → MCTS 搜索
    ↓                                      ↓
回傳結果 ← 格式化輸出 ← 獲取最佳動作 ← 搜索完成
```

### 狀態管理
- 使用不可變數據結構
- Copy-on-write 優化
- 緩存常見狀態

## 技術選型

### 核心技術棧
- **語言**: Python 3.11+
- **Web框架**: FastAPI
- **算法**: MCTS with UCB
- **優化**: Numba JIT

### 關鍵依賴
- numpy: 數值計算
- pydantic: 數據驗證
- pytest: 測試框架
- mypy: 類型檢查

## 接口設計

### REST API
```
POST /solve
  Request: {
    "game_state": {...},
    "time_limit": 300,
    "num_threads": 4
  }
  Response: {
    "action": {...},
    "expected_score": 15.3,
    "statistics": {...}
  }

POST /analyze
  Request: {
    "game_state": {...}
  }
  Response: {
    "evaluation": 12.5,
    "foul_risk": 0.15,
    "royalties": {...}
  }
```

## 性能考量

### 優化目標
- 單次評估: < 1μs
- MCTS 模擬: > 5000/秒
- 5分鐘內: > 1M 模擬

### 內存管理
- 對象池重用
- 緊湊數據結構
- 定期垃圾回收

## 測試策略

### 單元測試
- 領域模型測試
- 算法組件測試
- 性能基準測試

### 集成測試
- 完整遊戲流程
- API 端到端測試
- 壓力測試

## 部署架構

### 容器化
```dockerfile
FROM python:3.11-slim
# 多階段構建優化鏡像大小
```

### 擴展性
- 水平擴展支持
- 無狀態設計
- 負載均衡ready

---
*Generated by architect Sub Agent*